# ğŸ¦€ CrabVault API æ–‡æ¡£

æ¬¢è¿ä½¿ç”¨ CrabVault APIï¼ğŸ—„ï¸ è¿™æ˜¯ä¸€ä¸ªç®€æ´ã€é«˜æ•ˆä¸”ç±»ä¼¼ S3 çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ APIã€‚

æ‚¨å°†é€šè¿‡æ“ä½œå­˜å‚¨æ¡¶ï¼ˆBucketï¼‰å’Œå¯¹è±¡ï¼ˆObjectï¼‰çš„ URL æ¥ç®¡ç†å®ƒä»¬çš„æ•°æ®å’Œå…ƒæ•°æ®ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç»‘å®šåœ¨ä¸€èµ·çš„ã€‚

## ğŸ“– åŸºæœ¬æ¦‚å¿µ

### ğŸ“ API å…¥å£ç‚¹

æ‰€æœ‰ API çš„åŸºç¡€ URL æ˜¯ï¼š
```
http://your-server-address:32767
```

### ğŸ” è®¤è¯

è¯¦è§[é…ç½®æ–‡ä»¶](./é…ç½®æ–‡ä»¶.md)çš„ `server.auth` å—

### ğŸ“ è‡ªå®šä¹‰å…ƒæ•°æ®

æˆ‘ä»¬æ”¯æŒä¸¤ç§å…ƒæ•°æ®ï¼š

1. **ç³»ç»Ÿå…ƒæ•°æ®**: ä½¿ç”¨æ ‡å‡†çš„ HTTP å¤´éƒ¨ï¼Œä¾‹å¦‚ `Content-Type`, `ETag` ç­‰ã€‚
2. **ç”¨æˆ·å…ƒæ•°æ®**: æ‚¨å¯ä»¥é€šè¿‡æ·»åŠ  `X-Crab-Vault-User-Meta` è‡ªå®šä¹‰è¯·æ±‚å¤´æ¥å­˜å‚¨æ‚¨è‡ªå·±çš„é”®å€¼å¯¹ä¿¡æ¯ã€‚
    * ä¾‹å¦‚ï¼š`X-Crab-Vault-User-Meta:{"position":"Chongqing China","shot_on":"International Labour Day"}`ã€‚
    * æ³¨æ„ï¼šè¿™ä¸ªå¤´éƒ¨çš„å€¼å¿…é¡»ä¸º **BASE64_STANDARD** ç¼–ç çš„ utf-8 å­—ç¬¦ä¸²ï¼Œ<u>å¾€åçš„å®ä¾‹ä¸ºäº†å¯è¯»æ€§ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨æœªç¼–ç çš„åŸå§‹æ•°æ®</u>
    * åŒæ—¶ä¸ºäº†æ–¹ä¾¿ï¼Œæ‚¨ä¼ é€’æˆ–è€…æˆ‘è¿”å›æ—¶ï¼Œè¿™ä¸ªç”¨æˆ·è‡ªå®šä¹‰ä¿¡æ¯å‡ä½äº `X-Crab-Vault-User-Meta` å¤´éƒ¨ã€‚
    * åœ¨å“åº”ä¸­ï¼Œè¿™äº›å…ƒæ•°æ®ä¹Ÿä¼šä»¥ç›¸åŒçš„å¤´éƒ¨æ ¼å¼è¿”å›ã€‚
    * é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸æŒ‡å®šå¤´éƒ¨ï¼Œæˆ‘ä»¬å°†æŠŠ `X-Crab-Vault-User-Meta` è®¾ç½®ä¸ºç©ºçš„å¯¹è±¡

### âŒ é”™è¯¯å¤„ç†

å¦‚æœè¯·æ±‚å‡ºé”™ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ ‡å‡†çš„ HTTP é”™è¯¯çŠ¶æ€ç ï¼Œå“åº”ä½“é€šå¸¸æ˜¯ä¸€ä¸ªåŒ…å«é”™è¯¯ä¿¡æ¯çš„ JSON å¯¹è±¡ï¼Œå¦‚ï¼š
```json
{
    "objectMetaNotFound": {
        "bucket": "sylvan",
        "object": "somefile"
    }
}
```

---

## ğŸª£ å­˜å‚¨æ¡¶ (Bucket) æ“ä½œ

å­˜å‚¨æ¡¶æ˜¯å­˜æ”¾å¯¹è±¡çš„å®¹å™¨ã€‚

### 1. åˆ›å»ºå­˜å‚¨æ¡¶ (Create a Bucket)

åˆ›å»ºä¸€ä¸ªæ–°çš„å­˜å‚¨æ¡¶æ¥å­˜æ”¾æ‚¨çš„å¯¹è±¡ã€‚æ­¤æ“ä½œæ˜¯å¹‚ç­‰çš„ã€‚

* **Endpoint**: `PUT /{bucket_name}`
* **æè¿°**: å¦‚æœå­˜å‚¨æ¡¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒã€‚å¦‚æœå·²å­˜åœ¨ï¼Œæ­¤æ“ä½œä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚
* **è·¯å¾„å‚æ•°**:
    * `bucket_name` (string, required): æ‚¨æƒ³è¦åˆ›å»ºçš„å­˜å‚¨æ¡¶çš„åç§°ã€‚
* **è¯·æ±‚å¤´** (å¯é€‰): `X-Crab-Vault-User-Meta`ã€‚
* **æˆåŠŸå“åº”**:
* `201 Created`: å­˜å‚¨æ¡¶è¢«æˆåŠŸåˆ›å»ºã€‚
* **cURL ç¤ºä¾‹**:
```bash
# åˆ›å»ºä¸€ä¸ªåä¸º "my-awesome-bucket" çš„å­˜å‚¨æ¡¶å¹¶é™„åŠ å…ƒæ•°æ®
curl -X PUT http://localhost:3000/my-awesome-bucket \
    -H "Content-Type: application/json" \
    -H "X-Crab-Vault-User-Meta: {\"project\":\"Project Phoenix\"}"
```

### 2. åˆ é™¤å­˜å‚¨æ¡¶ (Delete a Bucket)

åˆ é™¤ä¸€ä¸ªç©ºçš„å­˜å‚¨æ¡¶ã€‚

* **Endpoint**: `DELETE /{bucket_name}`
* **æè¿°**: åªæœ‰å½“å­˜å‚¨æ¡¶ä¸­æ²¡æœ‰ä»»ä½•å¯¹è±¡æ—¶ï¼Œæ‰èƒ½æˆåŠŸåˆ é™¤ã€‚
* **æˆåŠŸå“åº”**:
    * `204 No Content`: å­˜å‚¨æ¡¶è¢«æˆåŠŸåˆ é™¤ã€‚
* **é”™è¯¯å“åº”**:
    * `409 Conflict`: å¦‚æœå­˜å‚¨æ¡¶ä¸ä¸ºç©ºã€‚
    * `404 Not Found`: å¦‚æœå­˜å‚¨æ¡¶ä¸å­˜åœ¨ã€‚
* **cURL ç¤ºä¾‹**:
```bash
curl -X DELETE http://localhost:32767/my-awesome-bucket
```

---

## ğŸ“„ å¯¹è±¡ (Object) æ“ä½œ

å¯¹è±¡æ˜¯æ‚¨å­˜å‚¨åœ¨ CrabVault ä¸­çš„åŸºæœ¬æ•°æ®å•å…ƒã€‚

### 1. ğŸ“¤ ä¸Šä¼ /æ›´æ–°å¯¹è±¡ (Upload/Update an Object)

ä¸Šä¼ ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæˆ–è€…ç”¨æ–°æ•°æ®å®Œå…¨æ›¿æ¢ä¸€ä¸ªå·²æœ‰çš„å¯¹è±¡ã€‚

* **Endpoint**: `PUT /{bucket_name}/{*object_name}`
* **æè¿°**: å°†è¯·æ±‚ä½“ä¸­çš„æ•°æ®ä½œä¸ºå¯¹è±¡å†…å®¹è¿›è¡Œå­˜å‚¨ï¼Œå¹¶ä»è¯·æ±‚å¤´ä¸­æå–å…ƒæ•°æ®ã€‚
* **è·¯å¾„å‚æ•°**:
    * `bucket_name` (string, required): å¯¹è±¡æ‰€åœ¨çš„å­˜å‚¨æ¡¶ã€‚
    * `object_name` (string, required): å¯¹è±¡çš„å®Œæ•´è·¯å¾„åï¼Œä¾‹å¦‚ `images/avatars/user123.jpg`ã€‚
* **è¯·æ±‚å¤´**:
    * `Content-Type` (string, required): å¯¹è±¡çš„ MIME ç±»å‹ã€‚
    * `X-Crab-Vault-User-Meta` (string, optional): JSON å½¢å¼çš„ç”¨æˆ·è‡ªå®šä¹‰å…ƒæ•°æ®ã€‚
* **è¯·æ±‚ä½“**: å¯¹è±¡çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ã€‚
* **æˆåŠŸå“åº”**:
    * `201 Created`: å¯¹è±¡è¢«æˆåŠŸåˆ›å»ºæˆ–æ›´æ–°ã€‚
* **cURL ç¤ºä¾‹**:
```bash
# ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡ï¼Œå¹¶é™„å¸¦è‡ªå®šä¹‰å…ƒæ•°æ®
curl -X PUT http://localhost:3000/my-awesome-bucket/photos/paris.jpg \
    -H "Content-Type: image/jpeg" \
    -H "X-Crab-Vault-User-Meta: {"name":\"John Doe\"}" \
    --data-binary "@path/to/your/local/image.jpg"
```

### 2. ğŸ“¥ ä¸‹è½½å¯¹è±¡ (Download an Object)

è·å–ä¸€ä¸ªå¯¹è±¡çš„å®Œæ•´æ•°æ®å’Œå…¶æ‰€æœ‰å…ƒæ•°æ®ã€‚

* **Endpoint**: `GET /{bucket_name}/{*object_name}`
* **æè¿°**: è¿”å›å¯¹è±¡çš„å…ƒæ•°æ®ï¼ˆåœ¨å“åº”å¤´ä¸­ï¼‰å’Œæ•°æ®ï¼ˆåœ¨å“åº”ä½“ä¸­ï¼‰ã€‚
* **æˆåŠŸå“åº”**:
    * `200 OK`: æˆåŠŸè·å–å¯¹è±¡ã€‚å“åº”å¤´åŒ…å«æ‰€æœ‰å…ƒæ•°æ®ï¼Œå“åº”ä½“æ˜¯å¯¹è±¡çš„æ•°æ®ã€‚
* **cURL ç¤ºä¾‹**:
```bash
# ä¸‹è½½å¯¹è±¡å¹¶æ˜¾ç¤ºå“åº”å¤´ä¿¡æ¯ (-v)
curl -v http://localhost:3000/my-awesome-bucket/photos/paris.jpg -o downloaded_paris.jpg
```
æ‚¨å°†åœ¨ç»ˆç«¯è¾“å‡ºä¸­çœ‹åˆ°ç±»ä¼¼ `ETag`, `Content-Type`, `X-Crab-Vault-User-Meta` ç­‰å“åº”å¤´ã€‚

### 3. ğŸ” è·å–å¯¹è±¡å…ƒæ•°æ® (Get Object Metadata)

ä»…è·å–ä¸€ä¸ªå¯¹è±¡çš„å…ƒæ•°æ®ï¼Œä¸ä¸‹è½½å…¶æ•°æ®ã€‚éå¸¸é€‚åˆç”¨äºæ£€æŸ¥å¯¹è±¡çŠ¶æ€ã€‚

* **Endpoint**: `HEAD /{bucket_name}/{*object_name}`
* **æè¿°**: å’Œ `GET` è¯·æ±‚å®Œå…¨ç›¸åŒï¼Œä½†æœåŠ¡å™¨ **ä¸ä¼š** è¿”å›å“åº”ä½“ã€‚
* **æˆåŠŸå“åº”**:
    * `200 OK`: å“åº”å¤´ä¸­åŒ…å«äº†å¯¹è±¡çš„å…¨éƒ¨å…ƒæ•°æ®ã€‚
* **cURL ç¤ºä¾‹**:
```bash
# ä½¿ç”¨ -I é€‰é¡¹æ¥å‘é€ HEAD è¯·æ±‚
curl -I http://localhost:3000/my-awesome-bucket/photos/paris.jpg
```

### 4. âœï¸ æ›´æ–°å¯¹è±¡å…ƒæ•°æ® (Update Object Metadata)

åœ¨ä¸é‡æ–°ä¸Šä¼ æ•´ä¸ªå¯¹è±¡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ **ç”¨æˆ·å…ƒæ•°æ®**ã€‚

* **Endpoint**: `PATCH /{bucket_name}/{*object_name}`
* **æè¿°**: è¯·æ±‚ä½“ä¸­çš„ JSON å¯¹è±¡å°†è¢«åˆå¹¶åˆ°ç°æœ‰çš„ç”¨æˆ·å…ƒæ•°æ®ä¸­ã€‚å·²æœ‰çš„é”®å°†è¢«æ›´æ–°ï¼Œæ–°çš„é”®å°†è¢«æ·»åŠ ï¼Œå¦‚æœæƒ³åˆ é™¤æ—§çš„é”®ï¼Œè¯·å°†å¯¹åº”çš„å€¼ç½®ä¸ºç©º
* **è¯·æ±‚ä½“**: æ— ã€‚
* **æˆåŠŸå“åº”**:
    * `200 OK`: å…ƒæ•°æ®æ›´æ–°æˆåŠŸã€‚
* **cURL ç¤ºä¾‹**:
```bash
curl -X PATCH http://localhost:3000/my-awesome-bucket/photos/paris.jpg \
    -H "Content-Type: application/json" \
    -H "X-Crab-Vault-User-Meta: {\"reviewed\":true,\"location\":\"Eiffel Tower\"}"
"
```

### 5. ğŸ—‘ï¸ åˆ é™¤å¯¹è±¡ (Delete an Object)

ä»å­˜å‚¨æ¡¶ä¸­æ°¸ä¹…åˆ é™¤ä¸€ä¸ªå¯¹è±¡åŠå…¶æ‰€æœ‰å…ƒæ•°æ®ã€‚

* **Endpoint**: `DELETE /{bucket_name}/{*object_name}`
* **æè¿°**: æ­¤æ“ä½œæ˜¯å¹‚ç­‰çš„ã€‚åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„å¯¹è±¡ä¹Ÿä¼šè¿”å›æˆåŠŸã€‚
* **æˆåŠŸå“åº”**:
    * `204 No Content`: å¯¹è±¡è¢«æˆåŠŸåˆ é™¤æˆ–æœ¬æ¥å°±ä¸å­˜åœ¨ã€‚
* **cURL ç¤ºä¾‹**:
```bash
curl -X DELETE http://localhost:3000/my-awesome-bucket/photos/paris.jpg
```

---

## ğŸ¦Œ åˆ—è¡¨æ“ä½œ

### 1. è·å–æ‰€æœ‰æ¡¶çš„å…ƒæ•°æ® ï¼ˆList All Buckets Metadataï¼‰

è·å–æ‰€æœ‰æ¡¶çš„å…ƒæ•°æ®

- **Endpoint**:`GET /`
- **æè¿°**ï¼šæ­¤æ“ä½œä¼šå°†æ‰€æœ‰æ¡¶çš„å…ƒæ•°æ®ä¸‹è½½ä¸‹æ¥ï¼Œä»¥ JSON åˆ—è¡¨çš„å½¢å¼
- æˆåŠŸå“åº”ï¼š
    - `200 OK`ï¼šå‰©ä½™çš„å…ƒæ•°æ®ä¼šæ”¾åœ¨å“åº”ä½“ä¸­
- **cURLç¤ºä¾‹**

```bash
curl -v http://localhost:32767
```

- **å“åº”ç¤ºä¾‹ï¼ˆå¤´éƒ¨çš„ X-Crab-Vault-User-Metaï¼‰**

```json
[
  {
    "meta": {
      "name": "some",
      "created-at": "2025-08-20T05:02:40.777065800Z",
      "updated-at": "2025-08-20T05:02:40.777068400Z",
      "user-meta": {}
    }
  },
  {
    "meta": {
      "name": "sylvan",
      "created-at": "2025-08-20T05:02:47.129737Z",
      "updated-at": "2025-08-20T05:02:47.129739800Z",
      "user-meta": {}
    }
  }
]
```

### 2. è·å–æŸä¸€ä¸ªæ¡¶å†…æ‰€æœ‰å¯¹è±¡çš„å…ƒæ•°æ®

### 1. è·å–æ‰€æœ‰æ¡¶çš„å…ƒæ•°æ® ï¼ˆList All Buckets Metadataï¼‰

è·å–æ‰€æœ‰æ¡¶çš„å…ƒæ•°æ®

- **Endpoint**:`GET /{bucket_name}`
- **æè¿°**ï¼šæ­¤æ“ä½œä¼šå°†æŒ‡å®šæ¡¶å†…æ‰€æœ‰å¯¹è±¡çš„å…ƒæ•°æ®ä¸‹è½½ä¸‹æ¥ï¼Œä»¥ JSON åˆ—è¡¨çš„å½¢å¼
- **æˆåŠŸå“åº”**ï¼š
    - `200 OK`ï¼šå‰©ä½™çš„å…ƒæ•°æ®ä¼šæ”¾åœ¨å“åº”ä½“ä¸­
- **cURLç¤ºä¾‹**

```bash
curl -v http://localhost:32767/sylvan
```

- **å“åº”ç¤ºä¾‹ï¼ˆå¤´éƒ¨çš„ X-Crab-Vault-User-Metaï¼‰**

```json
[
  {
    "object-name": "anotherfile.json",
    "bucket-name": "sylvan",
    "size": 22,
    "content-type": "application/json",
    "etag": "S9rLr0zoRYiZQquJ+Zcw1jRIp9gVItI55ZFhEpMExwk",
    "created-at": "2025-08-20T05:08:23.789410600Z",
    "updated-at": "2025-08-20T05:08:23.789411100Z",
    "user-meta": {
      "user": "alex"
    }
  },
  {
    "object-name": "somefile.json",
    "bucket-name": "sylvan",
    "size": 22,
    "content-type": "application/json",
    "etag": "S9rLr0zoRYiZQquJ+Zcw1jRIp9gVItI55ZFhEpMExwk",
    "created-at": "2025-08-20T05:02:13.464651600Z",
    "updated-at": "2025-08-20T05:02:13.464652600Z",
    "user-meta": {
      "user": "sylvan"
    }
  }
]
```

---
